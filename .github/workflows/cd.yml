name: ðŸš€ CD - Deploy to Production

on:
  push:
    branches: [main]

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-northeast-2
  K8S_NAMESPACE: prod
  HELM_RELEASE: jibangyoung

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubDeployRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Docker Login & Build Push (Backend)
        working-directory: backend
        run: |
          docker build -t ghcr.io/${{ github.repository }}/backend:latest .
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login ghcr.io -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          docker push ghcr.io/${{ github.repository }}/backend:latest

      - name: Docker Login & Build Push (Frontend)
        working-directory: frontend
        run: |
          docker build -t ghcr.io/${{ github.repository }}/frontend:latest .
          docker push ghcr.io/${{ github.repository }}/frontend:latest

      - name: Deploy via Helm
        run: |
          helm upgrade --install ${{ env.HELM_RELEASE }} ./infra/helm \
            --namespace=${{ env.K8S_NAMESPACE }} \
            --set image.backend.tag=latest \
            --set image.frontend.tag=latest \
            --values=./infra/helm/values-prod.yaml
