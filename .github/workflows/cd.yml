name: ğŸš€ CD - Deploy to Production

on:
  push:
    branches: [main] # ìš´ì˜ ë°°í¬ëŠ” main ë¸Œëœì¹˜ì—ë§Œ ë°˜ì‘

permissions:
  id-token: write # OIDC ì¸ì¦ ìœ„í•´ í•„ìš”
  contents: read # ì†ŒìŠ¤ì½”ë“œ ì½ê¸° ê¶Œí•œ

env:
  AWS_REGION: ap-northeast-2
  AWS_ROLE_NAME: GitHubDeployRole
  K8S_NAMESPACE: prod
  HELM_RELEASE: jibangyoung

jobs:
  deploy:
    name: Production Deploy
    runs-on: ubuntu-latest

    steps:
      # âœ… Step 1: GitHub ë ˆí¬ì§€í† ë¦¬ Checkout
      - name: Checkout Repository
        uses: actions/checkout@v4

      # âœ… Step 2: AWS OIDC ì¸ì¦ (ê¶Œí•œ ìœ„ì„)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ env.AWS_ROLE_NAME }}
          aws-region: ${{ env.AWS_REGION }}

      # âœ… Step 3: Docker ë¡œê·¸ì¸ ë° Backend ë¹Œë“œ/í‘¸ì‹œ
      - name: Docker Login & Build Push (Backend)
        working-directory: backend
        env:
          IMAGE: ghcr.io/${{ github.repository }}/backend:latest
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login ghcr.io -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          docker build -t $IMAGE .
          docker push $IMAGE

      # âœ… Step 4: Docker ë¹Œë“œ/í‘¸ì‹œ (Frontend)
      - name: Docker Login & Build Push (Frontend)
        working-directory: frontend
        env:
          IMAGE: ghcr.io/${{ github.repository }}/frontend:latest
        run: |
          docker build -t $IMAGE .
          docker push $IMAGE

      # âœ… Step 5: Helmìœ¼ë¡œ Kubernetes ë°°í¬
      - name: Deploy via Helm
        run: |
          helm upgrade --install ${{ env.HELM_RELEASE }} ./infra/helm \
            --namespace=${{ env.K8S_NAMESPACE }} \
            --create-namespace \
            --set image.backend.tag=latest \
            --set image.frontend.tag=latest \
            --values=./infra/helm/values-prod.yaml
